一、定向调度策略 NodeName 与 NodeSelector
---
在 Kubernetes 中有两种定向调度方式，可以通过配置 Kubernetes 对象的 nodeName 和 NodeSelector 两个参数，来使应用部署到特定的节点上。

1、NodeName 方式

(1)、设置 Deployment 对象配置 nodeName 参数
```
# vim deploy.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello
  labels:
    app: hello
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hello
  template:
    metadata:
      labels:
        app: hello
    spec:
      containers:
      - name: hello
        image: tutum/hello-world:latest
        ports:
        - containerPort: 80
      nodeName: k8s-node-2-12            #指定调度节点为 k8s-node-2-12
```

(2)、执行部署应用
```
$ kubectl create -f deploy.yaml
```

(3)、查看启动的应用所在节点
```
$ kubectl get pods -o wide

NAME                     READY   STATUS    RESTARTS   AGE   IP               NODE            
hello-768b645b56-wgqp7   1/1     Running     0        17s   10.244.134.228 k8s-node-2-12
```

2、NodeSelector 方式

(1)、设置节点添加对应 Label 标签

对节点设置 Label 标签：

格式： kubectl label nodes <标签Key>=<标签Value>
```
$ kubectl label nodes k8s-node-2-12 deploy=hello
```
查看节点的 Label 标签：
```
$ kubectl get nodes --show-labels 
```
(2)、设置 Deployment 对象配置 nodeSelector 参数
```
# vim deploy.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello
  labels:
    app: hello
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hello
  template:
    metadata:
      labels:
        app: hello
    spec:
      containers:
      - name: hello
        image: tutum/hello-world:latest
        ports:
        - containerPort: 80
      nodeSelector:
        deploy: hello     #调度到拥有 label 为 deploy=hello 的节点
```

(3)、执行部署应用
```
$ kubectl create -f deploy.yaml
```
(4)、查看启动的应用所在节点
```
$ kubectl get pods -o wide

NAME                    READY   STATUS    RESTARTS   AGE   IP               NODE         
hello-bc58f99c8-fpd5t   1/1     Running   0          17s   10.244.134.232   k8s-node-2-12
```

二、亲和性 Affinity
---

| 调度策略 | 匹配标签 | 操作符 | 拓扑域支持 | 调度目标 |
| :------: | :--------: | :-------: | :-----: | :---------: |
| nodeAffinity | 主机 | In, NotIn, Exists,DoesNotExist, Gt, Lt | 否 | 指定主机 |
| podAffinity | POD | In, NotIn, Exists,DoesNotExist | 是 | POD与指定POD同一拓扑域 |
| podAnitAffinity | POD | In, NotIn, Exists,DoesNotExist | 是 | POD与指定POD不在同一拓扑域 |

1、Affinity 介绍
由于上面 NodeName 和 NodeSelector 两种调度方式过于生硬，不能够灵活配置应用能启动在什么节点、不启动在什么节点与配置两个相同的实例启动在不同的节点等等规则。所以 Kubernetes 中还有另一种调度方式，那就是 Affinity 亲和性，这种方式可以非常灵活的配置应用的调度规则。

(1)、Affinity 可以分为三种类
- NodeAffinity: Node 亲和性
- PodAffinity： Pod 亲和性
- PodAntiAffinity： Pod 反亲和性

(2)、亲和性调度可以分成软策略和硬策略两种方式
- preferredDuringSchedulingIgnoredDuringExecution（软策略）： 如果没有满足调度要求的节点，Pod 就会忽略这条规则，继续完成调度过程，即是满足条件最好，没有满足也无所谓的一种策略。
- requiredDuringSchedulingIgnoredDuringExecution（硬策略）： 比较强硬，如果没有满足条件的节点的话，就不断重试直到满足条件为止，即是必须满足该要求，不然不调度的策略。

2、相关参数介绍

(1)、调度条件参数：

- nodeSelectorTerms：下面有多个选项的话，满足任何一个条件就可以了；
- matchExpressions：有多个选项的话，则必须同时满足这些条件才能正常调度 POD。

(2)、权重 weight 参数：

- 权重范围为 1-100，权重的值涉及调度器的优选打分过程，每个节点的评分都会加上这个 weight，最后绑定最高的节点。

(3)、拓扑域 topologyKey 参数及可配置选项：

topologykey 的值表示指作用于 topology 范围内的 node 上运行的 pod，其值可配置为：

- kubernetes.io/hostname（Node）
- failure-domain.beta.kubernetes.io/zone（Zone）
- failure-domain.beta.kubernetes.io/region（Region）

(4)、匹配选项 operator 可用的选项：
- In： label 的值在某个列表中
- NotIn： label 的值不在某个列表中
- Gt： label 的值大于某个值
- Lt： label 的值小于某个值
- Exists： 某个 label 存在
- DoesNotExist： 某个 label 不存在


节点硬亲和性  
```
apiVersion: v1
kind: Pod
metadata:
  name: with-required-nodeaffinity-2
spec:
  affinity:
    nodeAffinity:                                                    #节点亲和性
      requiredDuringSchedulingIgnoredDuringExecution:                #硬亲和性
        nodeSelectorTerms:                                           #标签选择器
        - matchExpressions:                                          #匹配的标签
          - {key: zone, operator: In, values: ["foo", "bar"]}        #根据values匹配，值不能为空 operator选项有In、NotIn
          - {key: ssd, operator: Exists, values: []}                 #存在性匹配，值必选为空  operator选项Exists、DoesNotExist
  containers:
  - name: myapp
    image: ikubernetes/myapp:v1
    resources:
      requests:
        cpu: 6
        memory: 20Gi
```  

同上不同写法
```
apiVersion: v1
kind: Pod
metadata:
  name: affinity
  labels:
    app: node-affinity-pod
spec:
  containers:
  - name: with-node-affinity
    image: ikubernetes/myapp:v1
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/hostname
            operator: NotIn
            values:
            - k8s-node02
```  
键值运算关系  
- In：label 的值在某个列表中
- NotIn：label 的值不在某个列表中
- Gt：label 的值大于某个值
- Lt：label 的值小于某个值
- Exists：某个 label 存在
- DoesNotExist：某个 label 不存在


节点软亲和性  
```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-deploy-with-node-affinity
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      name: myapp-pod
      labels:
        app: myapp
    spec:
      affinity:
        nodeAffinity:                                              #节点亲和性
          preferredDuringSchedulingIgnoredDuringExecution:         #软亲和性
          - weight: 60                                             #权重1-100数值越高优先级越高
            preference:
              matchExpressions:                                    #匹配方式
              - {key: zone, operator: In, values: ["foo"]}
          - weight: 30                                             #如果有多个模式匹配合适，权重高的优先
            preference:
              matchExpressions:
              - {key: ssd, operator: Exists, values: []}
      containers:
      - name: myapp
        image: ikubernetes/myapp:v1
```  

同上不同写法
```
apiVersion: v1
kind: Pod
metadata:
  name: affinity
  labels:
    app: node-affinity-pod
spec:
  containers:
  - name: with-node-affinity
    image: ikubernetes/myapp:v1
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 1
        preference:
          matchExpressions:
          - key: kubernetes.io/hostname
            operator: In
            values:
            - k8s-node02
```  

硬策略和软策略同时使用，先满足硬策略再满足软策略
```
apiVersion: v1
kind: Pod
metadata:
  name: affinity
  labels:
    app: node-affinity-pod
spec:
  containers:
  - name: with-node-affinity
    image: ikubernetes/myapp:v1
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/hostname
            operator: NotIn
            values:
            - k8s-node02
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 1
        preference:
          matchExpressions:
          - key: source
            operator: In
            values:
            - qikqiak
```

pod硬亲和性
```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-with-pod-affinity
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      name: myapp
      labels:
        app: myapp
    spec:
      affinity:
        podAffinity:                                            #pod亲和性
          requiredDuringSchedulingIgnoredDuringExecution:       #硬亲和性
          - labelSelector:                                      #标签选择器
              matchExpressions:                                 #匹配方法
              - {key: app, operator: In, values: ["db"]}
            topologyKey: zone                                   #以节点标签的key为标准，作为拓扑域，在同一域内进行匹配
      containers:
      - name: myapp
        image: ikubernetes/myapp:v1
```  


pod软亲和性
```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-with-preferred-pod-affinity
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      name: myapp
      labels:
        app: myapp
    spec:
      affinity:
        podAffinity:                                             #pod亲和性
          preferredDuringSchedulingIgnoredDuringExecution:       #软亲和性
          - weight: 80
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - {key: app, operator: In, values: ["db"]}
              topologyKey: rack
          - weight: 20
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - {key: app, operator: In, values: ["db"]}
              topologyKey: zone
      containers:
      - name: myapp
        image: ikubernetes/myapp:v1
```  


pod反亲和性  
```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-with-pod-anti-affinity
spec:
  replicas: 4
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      name: myapp
      labels:
        app: myapp
    spec:
      affinity:
        podAntiAffinity:                                       #反亲和性
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - {key: app, operator: In, values: ["myapp"]}
            topologyKey: kubernetes.io/hostname
      containers:
      - name: myapp
        image: ikubernetes/myapp:v1
```
